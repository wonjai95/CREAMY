<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <!--
	작성자 : 
	작성일 : 
	 에서 사용하는 mapper
-->
  
  
  <mapper namespace="com.spring.Creamy_CRM.Host_dao.EmployeeDAO">
  
  <!--
	작성자 : 주수림
	작성일 : 2021-09-20
	시작
-->
  
	 <!-- 직원 목록 조회 -->
	<select id="employeeList" parameterType="String" resultType="com.spring.Creamy_CRM.VO.EmployeeVO">
		SELECT * 
		  FROM employee_tbl 
		 WHERE host_code = #{host_code}
		 ORDER BY TO_NUMBER(SUBSTR(employee_code,2)) DESC
	</select>
	
	<!-- 직원 상세 정보 조회 -->
	<select id="getEmployeeDetail" parameterType="String" resultType="com.spring.Creamy_CRM.VO.EmployeeVO">
		SELECT *
		  FROM employee_tbl
		 WHERE employee_code = #{employee_code}
	</select>
	
	<!--  -->
	<select id="getAttendanceList" parameterType="String" resultType="com.spring.Creamy_CRM.VO.AttendanceVO">
		SELECT *
		  FROM attendance_tbl
		 WHERE employee_code = #{employee_code}
	</select>
	
	<!-- 이미 직원 등록이 완료된 id인지 체크 -->
	<select id="chkEmployeeIdPreexisting" parameterType="String" resultType="Integer">
		SELECT COUNT(*) 
		  FROM employee_tbl 
		 WHERE employee_id = #{employee_id}
	</select>
   
   <!-- 직원 등록시 id 확인 -->
	<select id="chkEmployeeIdAction" parameterType="String" resultType="Integer">
		SELECT COUNT(*) 
		  FROM Auth_tbl 
		 WHERE ID = #{ID}
	</select>
	
	<!-- 직원 id와 pwd를 Auth 테이블에 삽입 -->
	<insert id="insertEmployeeAuth" parameterType="java.util.Map">
  		insert into Auth_tbl(ID, password, key, authority, enabled)
  		values(#{ID}, #{password}, #{key}, 'ROLE_EMP', 1)
  	</insert>
   
	<!-- 직원 등록  -->
	<insert id="insertEmployee" parameterType="com.spring.Creamy_CRM.VO.EmployeeVO">
		INSERT INTO employee_tbl(employee_code, employee_id, host_code, employee_name, employee_gender, employee_age, employee_email, employee_address, 
		   				 employee_ph, employee_hireDate, employee_resignDate, department, position, duty, job, employee_type, annual_leave_cnt)
		VALUES ('E'||emp_seq.nextval, #{employee_id}, #{host_code}, #{employee_name}, #{employee_gender}, #{employee_age}, #{employee_email}, #{employee_address}, 
		    			#{employee_ph}, SYSDATE, null, #{department}, #{position}, #{duty}, #{job}, #{employee_type}, #{annual_leave_cnt})
	</insert>  	
  
  	<!-- 근태 - 출근 insert -->
  	<insert id="insertAttendance" parameterType="com.spring.Creamy_CRM.VO.AttendanceVO">
  		INSERT INTO attendance_tbl (attendance_code, employee_code, attendance_date, check_in_time, check_out_time, lateChk, temperature, examination_chk1, examination_chk2, examination_chk3, memo)
		VALUES ('AT'||attendance_seq.nextval, #{employee_code}, SYSDATE, #{check_in_time}, #{check_out_time}, #{lateChk}, #{temperature}, #{examination_chk1}, #{examination_chk2}, #{examination_chk3}, #{memo})
  	</insert>
  
  	<!-- 근태 - 퇴근시 출근 기록 확인, 중복 출근 체크 -->
  	<select id="chkIn" parameterType="com.spring.Creamy_CRM.VO.AttendanceVO" resultType="Integer">
  		SELECT COUNT(*)
  		  FROM attendance_tbl
  		 WHERE employee_code = #{employee_code}
  		   AND TO_CHAR(attendance_date, 'yyyy/MM/dd') = TO_CHAR(#{attendance_date}, 'yyyy/MM/dd')
  	</select>
  
  	<!-- 근태 - 퇴근시 attendance_tbl 퇴근시간 update -->
  	<update id="updateAttendanceOut" parameterType="com.spring.Creamy_CRM.VO.AttendanceVO">
  		UPDATE attendance_tbl
  		   SET check_out_time = #{check_out_time}
  		 WHERE employee_code = #{employee_code}
  		   AND TO_CHAR(attendance_date, 'yyyy/MM/dd') = TO_CHAR(#{attendance_date}, 'yyyy/MM/dd')
  	</update>
  	
  	<!-- 근무시간 등록 여부 체크 -->
  	<select id="chkWorkingHours" parameterType="String" resultType="Integer">
  		SELECT COUNT(*) 
  		  FROM working_hours_tbl
  		 WHERE employee_code = #{employee_code}
  	</select>
  	
  	<!-- 근무시간 등록  -->
  	<insert id="insertWorkingHours" parameterType="com.spring.Creamy_CRM.VO.WorkingHoursVO">
  		INSERT INTO working_hours_tbl (working_hours_code, employee_code, late_criteria, early_criteria, mon_in, mon_out, tue_in, tue_out, wed_in, wed_out, 
  										thu_in, thu_out, fri_in, fri_out, sat_in, sat_out, sun_in, sun_out, weekly_hours)
		VALUES ('WH'||working_hrs_seq.nextval, #{employee_code}, #{late_criteria}, #{early_criteria}, #{mon_in}, #{mon_out}, #{tue_in}, #{tue_out}, #{wed_in}, #{wed_out}, 
				#{thu_in}, #{thu_in}, #{fri_in}, #{fri_out}, #{sat_in}, #{sat_out}, #{sun_in}, #{sun_out}, #{weekly_hours})
  	</insert>
     
    <!-- 근무시간 update -->
    <update id="updateWorkingHours" parameterType="com.spring.Creamy_CRM.VO.WorkingHoursVO">
    	UPDATE working_hours_tbl
    	   SET late_criteria = #{late_criteria}, early_criteria = #{early_criteria}, mon_in = #{mon_in}, mon_out = #{mon_out},
    	   		tue_in = #{tue_in}, tue_out = #{tue_out}, wed_in = #{wed_in}, wed_out = #{wed_out}, thu_in = #{thu_in}, thu_out = #{thu_out},
    	   		fri_in = #{fri_in}, fri_out = #{fri_out}, sat_in = #{sat_in}, sat_out = #{sat_out}, sun_in = #{sun_in}, sun_out = #{sun_out}, weekly_hours = #{weekly_hours}
    	 WHERE employee_code = #{employee_code}
    </update>
     
    <!-- 휴가 사용일 조회 --> 
    <select id="getLeave_usage_cnt" parameterType="String" resultType="Integer">
    	SELECT leave_usage_cnt
    	  FROM leave_tbl
    	 WHERE employee_code = #{employee_code}
    </select>
     
     
  </mapper>